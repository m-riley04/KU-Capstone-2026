# METABEGIN
# X-Env-Layer-Name: polypod
# X-Env-Layer-Desc: Polypod dual-display Flutter kiosk (Sway + flutter-elinux)
# X-Env-Layer-Requires: rpi-user-credentials,systemd-net-min
# METAEND
---
mmdebstrap:
  packages:
    - sway
    - swaybg
    - swayidle
    - wlr-randr
    - xwayland
    - greetd
    - libinput-tools
    - libinput-bin
    - libts-bin
    - mesa-utils
    - libgles2-mesa
    - libegl1-mesa
    - libgbm1
    - libdrm2
    - libgtk-3-0
    - libglib2.0-0
    - libpango-1.0-0
    - libcairo2
    - libfontconfig1
    - fonts-noto
    - fonts-noto-cjk
    - openssh-server
    - rsync
    - curl
    - wget
    - jq
    - systemd-timesyncd
    - udev
    - i2c-tools
    - unzip
    - htop
    - strace
    - evtest
    - foot

  customize-hooks:
    # 1. Copy rootfs overlay (APPEND to config.txt, don't replace it)
    - |
      set -e
      OVERLAY="$SRCROOT/layer/polypod/rootfs-overlay"
      echo "[polypod] Copying rootfs overlay from: $OVERLAY"
      if [ ! -d "$OVERLAY" ]; then
        echo "[polypod] ERROR: rootfs-overlay not found at $OVERLAY"
        exit 1
      fi
      cp -av "$OVERLAY/." "$1/" 2>&1 | tail -20
      echo "[polypod] Verifying key files..."
      for check in \
        "$1/etc/polypod/polypod.conf" \
        "$1/etc/greetd/config.toml" \
        "$1/etc/systemd/system/app-update.timer" \
        "$1/etc/systemd/system/polypod-setup.service" \
        "$1/usr/local/bin/start-sway.sh" \
        "$1/home/pi/.config/sway/config"; do
        if [ -f "$check" ]; then
          echo "  OK: $(basename $check)"
        else
          echo "  MISSING: $check"
        fi
      done

    # 1b. APPEND display config to the base config.txt (do NOT overwrite it)
    - |
      set -e
      echo "[polypod] Appending display config to config.txt..."
      DISPLAY_CFG="$1/boot/firmware/polypod-display.txt"
      TARGET_CFG="$1/boot/firmware/config.txt"
      if [ -f "$DISPLAY_CFG" ] && [ -f "$TARGET_CFG" ]; then
        echo "" >> "$TARGET_CFG"
        cat "$DISPLAY_CFG" >> "$TARGET_CFG"
        rm "$DISPLAY_CFG"
        echo "  Appended. Final config.txt:"
        tail -25 "$TARGET_CFG"
      else
        echo "  WARNING: polypod-display.txt or config.txt missing"
      fi

    # 2. Waveshare DSI (E) overlay
    - |
      set -e
      echo "[polypod] Installing Waveshare DSI (E) overlay..."
      mkdir -p "$1/boot/firmware/overlays"
      if [ -f "$SRCROOT/work/overlays/Waveshare_35DSI.dtbo" ]; then
        cp "$SRCROOT/work/overlays/Waveshare_35DSI.dtbo" "$1/boot/firmware/overlays/Waveshare_35DSI.dtbo"
      else
        echo "  Not cached — will need to download manually or run: ./build.sh --cache-overlays"
      fi

    # 3. SPI LCD (G) firmware
    - |
      set -e
      echo "[polypod] Installing ST7796S firmware..."
      mkdir -p "$1/lib/firmware"
      if [ -f "$SRCROOT/work/firmware/st7796s.bin" ]; then
        cp "$SRCROOT/work/firmware/st7796s.bin" "$1/lib/firmware/st7796s.bin"
      else
        echo "  Not cached — will need to download manually or run: ./build.sh --cache-overlays"
      fi

    # 4. Pre-built Flutter app bundle
    - |
      echo "[polypod] Installing pre-built Flutter app bundle..."
      mkdir -p "$1/opt/polypod/app"
      if [ -d "$SRCROOT/work/flutter-bundle" ] && [ "$(ls -A "$SRCROOT/work/flutter-bundle" 2>/dev/null)" ]; then
        cp -a "$SRCROOT/work/flutter-bundle/." "$1/opt/polypod/app/"
        chmod +x "$1/opt/polypod/app/"* 2>/dev/null || true
        echo "  Bundle installed"
      else
        echo "  WARNING: No work/flutter-bundle/ found."
      fi

    # 5. Create shared/backup dirs
    - |
      mkdir -p "$1/opt/polypod/shared" "$1/opt/polypod/.backups"
      chown -R 1000:1000 "$1/opt/polypod"

    # 6. Enable services (with existence checks)
    - |
      echo "[polypod] Enabling services..."
      for unit in greetd ssh systemd-timesyncd; do
        chroot "$1" systemctl enable "${unit}.service" 2>&1 || echo "  warn: ${unit} enable failed"
      done
      if [ -f "$1/etc/systemd/system/app-update.timer" ]; then
        chroot "$1" systemctl enable app-update.timer
      else
        echo "  SKIP: app-update.timer not found in chroot"
      fi
      if [ -f "$1/etc/systemd/system/polypod-setup.service" ]; then
        chroot "$1" systemctl enable polypod-setup.service
      else
        echo "  SKIP: polypod-setup.service not found in chroot"
      fi
      chroot "$1" systemctl disable getty@tty1.service 2>/dev/null || true

    # 7. User service symlinks
    - |
      mkdir -p "$1/home/pi/.config/systemd/user/default.target.wants"
      for svc in polypod-top polypod-bottom polypod-bottom-spi; do
        if [ -f "$1/home/pi/.config/systemd/user/${svc}.service" ]; then
          ln -sf "/home/pi/.config/systemd/user/${svc}.service" \
                 "$1/home/pi/.config/systemd/user/default.target.wants/${svc}.service"
        else
          echo "  SKIP symlink: ${svc}.service not found"
        fi
      done
      chown -R 1000:1000 "$1/home/pi/.config"

    # 8. Make scripts executable (using find instead of glob)
    - |
      echo "[polypod] Setting script permissions..."
      if [ -d "$1/usr/local/bin" ]; then
        find "$1/usr/local/bin" -name "*.sh" -exec chmod +x {} \;
        echo "  Scripts found:"
        ls -la "$1/usr/local/bin/"*.sh 2>/dev/null || echo "  (none)"
      else
        echo "  WARNING: /usr/local/bin does not exist in chroot"
      fi

    # 9. Patch cmdline.txt for HDMI hot-plug
    - |
      CMDLINE="$1/boot/firmware/cmdline.txt"
      if [ -f "$CMDLINE" ]; then
        EXISTING=$(cat "$CMDLINE" | tr -d '\n')
        echo "${EXISTING} video=HDMI-A-1:1920x1080M@60D vc4.force_hotplug=1 consoleblank=0" > "$CMDLINE"
      fi
