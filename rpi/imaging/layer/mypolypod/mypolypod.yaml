# METABEGIN
# X-Env-Layer-Name: mypolypod
# X-Env-Layer-Category: app
# X-Env-Layer-Desc: Polypod - Cage kiosk + displays + Flutter app
# X-Env-Layer-Requires: rpi-user-credentials,systemd-net-min
#
# X-Env-VarPrefix: polypod
# METAEND
---
mmdebstrap:
  packages:
    # Cage kiosk compositor (single fullscreen Wayland window)
    - cage
    # Seat manager â€” cage needs this to access DRM/input without a display manager
    - seatd
    # Wayland utilities
    - wlr-randr

    # Utilities
    - bash
    - ca-certificates
    - curl
    - git
    - wget
    - unzip
    - sudo
    - file
    - xz-utils
    - zip
    - gettext-base  # provides envsubst

    # Python
    - python3
    - python3-venv
    - python3-pip
    - python3-spidev

    # Flutter BUILD deps
    - build-essential
    - cmake
    - ninja-build
    - clang
    - pkg-config
    - libgtk-3-dev

    # Flutter Linux desktop runtime deps
    - libgtk-3-0
    - libglib2.0-0
    - libegl1-mesa
    - libgl1-mesa-dri
    - libglu1-mesa
    - mesa-utils

  customize-hooks:
    # 1) Copy scripts into the image
    - |
      install -d "$1/opt/polypod/scripts"
      cp -a "$SRCROOT/scripts/." "$1/opt/polypod/scripts/"
      chmod -R +x "$1/opt/polypod/scripts" || true

    # 2) Run init (Flutter install, display drivers, app build)
    - |
      CACHE_HOST="$IGconf_sys_workroot/polypod-cache"
      mkdir -p "$CACHE_HOST"

      CACHE_CHROOT="/tmp/polypod-cache"
      mkdir -p "$1${CACHE_CHROOT}"
      mount --bind "$CACHE_HOST" "$1${CACHE_CHROOT}"

      PREBUILT_CHROOT=""
      if [ -d "$SRCROOT/prebuilt-app" ]; then
        PREBUILT_CHROOT="/tmp/polypod-prebuilt"
        mkdir -p "$1${PREBUILT_CHROOT}"
        mount --bind "$SRCROOT/prebuilt-app" "$1${PREBUILT_CHROOT}"
      fi

      chroot "$1" /usr/bin/env -i \
        HOME="/root" \
        PATH="/usr/sbin:/usr/bin:/sbin:/bin" \
        POLYPOD_USER="$IGconf_device_user1" \
        POLYPOD_CACHE="${CACHE_CHROOT}" \
        POLYPOD_PREBUILT="${PREBUILT_CHROOT}" \
        /bin/bash /opt/polypod/scripts/init.sh

      umount "$1${CACHE_CHROOT}" || true
      [ -n "$PREBUILT_CHROOT" ] && umount "$1${PREBUILT_CHROOT}" || true

    # 3) Install polypod.service from template (envsubst, like the kiosk example)
    - |
      export POLYPOD_USER="$IGconf_device_user1"
      envsubst < "$SRCROOT/polypod.service.tpl" > "$1/etc/systemd/system/polypod.service"
      chmod 0644 "$1/etc/systemd/system/polypod.service"

    # 4) Enable seatd (cage needs it for DRM/input access)
    - $BDEBSTRAP_HOOKS/enable-units "$1" seatd

    # 5) Add user to seat-related groups
    - chroot "$1" usermod -aG video,render,input "$IGconf_device_user1"

    # 6) Enable polypod service
    - $BDEBSTRAP_HOOKS/enable-units "$1" polypod