# METABEGIN
# X-Env-Layer-Name: mypolypod
# X-Env-Layer-Category: app
# X-Env-Layer-Desc: Polypod - Pi Desktop + displays + Flutter app autostart
# X-Env-Layer-Requires: rpi-user-credentials,systemd-net-min
#
# X-Env-VarPrefix: polypod
# METAEND
---
mmdebstrap:
  packages:
    # Full Raspberry Pi Desktop (LightDM + Wayfire + taskbar + everything)
    - raspberrypi-ui-mods

    # Wayland utilities
    - wlr-randr

    # Utilities
    - bash
    - ca-certificates
    - curl
    - git
    - wget
    - unzip
    - sudo
    - file
    - xz-utils 
    - zip

    # python
    - python3
    - python3-venv
    - python3-pip
    - python3-spidev

    # Flutter BUILD deps
    - build-essential
    - cmake
    - ninja-build
    - clang
    - pkg-config
    - libgtk-3-dev

    # Flutter Linux desktop runtime deps
    - libgtk-3-0
    - libglib2.0-0
    - libegl1-mesa
    - libgl1-mesa-dri
    - libglu1-mesa
    - mesa-utils

  customize-hooks:
    # 1) Copy scripts into the image
    - |
      install -d "$1/opt/polypod/scripts"
      cp -a "$SRCROOT/scripts/." "$1/opt/polypod/scripts/"
      chmod -R +x "$1/opt/polypod/scripts" || true

    # 2) Run init (Flutter install, display drivers, app build)
    - |
      CACHE_HOST="$IGconf_sys_workroot/polypod-cache"
      mkdir -p "$CACHE_HOST"

      CACHE_CHROOT="/tmp/polypod-cache"
      mkdir -p "$1${CACHE_CHROOT}"
      mount --bind "$CACHE_HOST" "$1${CACHE_CHROOT}"

      PREBUILT_CHROOT=""
      if [ -d "$SRCROOT/prebuilt-app" ]; then
        PREBUILT_CHROOT="/tmp/polypod-prebuilt"
        mkdir -p "$1${PREBUILT_CHROOT}"
        mount --bind "$SRCROOT/prebuilt-app" "$1${PREBUILT_CHROOT}"
      fi

      chroot "$1" /usr/bin/env -i \
        HOME="/root" \
        PATH="/usr/sbin:/usr/bin:/sbin:/bin" \
        POLYPOD_USER="$IGconf_device_user1" \
        POLYPOD_CACHE="${CACHE_CHROOT}" \
        POLYPOD_PREBUILT="${PREBUILT_CHROOT}" \
        /bin/bash /opt/polypod/scripts/init.sh

      umount "$1${CACHE_CHROOT}" || true
      [ -n "$PREBUILT_CHROOT" ] && umount "$1${PREBUILT_CHROOT}" || true

    # 3) Enable LightDM and set graphical boot target
    - $BDEBSTRAP_HOOKS/enable-units "$1" lightdm
    - chroot "$1" /bin/systemctl set-default graphical.target

    # 4) Configure LightDM autologin
    #    CRITICAL: cannot use printf with single-quoted format strings here
    #    because bdebstrap wraps each hook in sh -c '...' which breaks
    #    inner single quotes. Use a | block with cat heredoc instead.
    - |
      mkdir -p "$1/etc/lightdm/lightdm.conf.d"
      cat > "$1/etc/lightdm/lightdm.conf.d/10-autologin.conf" << AUTOLOGINEOF
      [Seat:*]
      autologin-user=$IGconf_device_user1
      autologin-user-timeout=0
      AUTOLOGINEOF
      sed -i 's/^      //' "$1/etc/lightdm/lightdm.conf.d/10-autologin.conf"

    # 5) XDG autostart - Flutter app launches as a desktop window after login
    - |
      AUTOSTART_DIR="$1/home/$IGconf_device_user1/.config/autostart"
      mkdir -p "$AUTOSTART_DIR"
      cat > "$AUTOSTART_DIR/polypod.desktop" << DESKTOPEOF
      [Desktop Entry]
      Type=Application
      Name=Polypod
      Exec=/opt/polypod/app/polypod_hw
      X-GNOME-Autostart-enabled=true
      DESKTOPEOF
      sed -i 's/^      //' "$AUTOSTART_DIR/polypod.desktop"
      chroot "$1" chown -R "$IGconf_device_user1:$IGconf_device_user1" \
        "/home/$IGconf_device_user1/.config"
