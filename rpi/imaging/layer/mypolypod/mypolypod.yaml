# METABEGIN
# X-Env-Layer-Name: mypolypod
# X-Env-Layer-Category: app
# X-Env-Layer-Desc:
# X-Env-Layer-Requires: rpi-user-credentials,systemd-net-min
#
# X-Env-VarPrefix: polypod
# METAEND
---
mmdebstrap:
  setup-hooks:
    - mkdir -p "$1/usr/share/keyrings"
    - chmod 0755 "$1/usr/share/keyrings"

    # Debian archive keys (Trixie / Debian 13)
    - curl -fsSL https://ftp-master.debian.org/keys/archive-key-13.asc -o "$1/usr/share/keyrings/archive-key-13.asc"
    - gpg --dearmor --yes -o "$1/usr/share/keyrings/debian-archive-keyring.gpg" "$1/usr/share/keyrings/archive-key-13.asc"

    - curl -fsSL https://ftp-master.debian.org/keys/archive-key-13-security.asc -o "$1/usr/share/keyrings/archive-key-13-security.asc"
    - gpg --dearmor --yes -o "$1/usr/share/keyrings/debian-security-archive-keyring.gpg" "$1/usr/share/keyrings/archive-key-13-security.asc"

    # Raspberry Pi repo key
    - curl -fsSL https://archive.raspberrypi.com/debian/raspberrypi.gpg.key -o "$1/usr/share/keyrings/raspberrypi.asc"
    - gpg --dearmor --yes -o "$1/usr/share/keyrings/raspberrypi.gpg" "$1/usr/share/keyrings/raspberrypi.asc"

    # Make keyrings readable by _apt
    - chmod 0644 "$1/usr/share/keyrings/debian-archive-keyring.gpg"
    - chmod 0644 "$1/usr/share/keyrings/debian-security-archive-keyring.gpg"
    - chmod 0644 "$1/usr/share/keyrings/raspberrypi.gpg"

    # Sources pinned to those keyrings (signed-by)
    - rm -f "$1/etc/apt/sources.list"
    - rm -f "$1/etc/apt/sources.list.d/"*
    - |-
      cat > "$1/etc/apt/sources.list" <<'EOF'
      deb [arch=arm64 signed-by=/usr/share/keyrings/debian-archive-keyring.gpg] http://deb.debian.org/debian trixie main
      deb [arch=arm64 signed-by=/usr/share/keyrings/debian-security-archive-keyring.gpg] http://deb.debian.org/debian-security trixie-security main
      deb [arch=arm64 signed-by=/usr/share/keyrings/debian-archive-keyring.gpg] http://deb.debian.org/debian trixie-updates main
      EOF
    - |-
      cat > "$1/etc/apt/sources.list.d/raspberrypi.list" <<'EOF'
      deb [arch=arm64 signed-by=/usr/share/keyrings/raspberrypi.gpg] http://archive.raspberrypi.com/debian trixie main
      EOF
    
  packages:
    # Used by hooks/scripts
    - bash
    - ca-certificates
    - curl
    - git
    - wget
    - unzip
    - xz-utils
    - zip
    - file
    - gettext-base   # provides envsubst

    # Flutter (Linux desktop) deps (matching your intent)
    - libglu1-mesa
    - cmake
    - ninja-build
    - clang
    - pkg-config
    - libgtk-3-dev
    - mesa-utils

  customize-hooks:
    # 1) Copy scripts into the image
    - |
      install -d "$1/opt/polypod/scripts"
      cp -a "${@SRCROOT}/scripts/." "$1/opt/polypod/scripts/"
      chmod -R +x "$1/opt/polypod/scripts" || true

    # 2) Run build-time init inside the target rootfs
    #    Pass POLYPOD_USER so init_flutter can run flutter as the normal user.
    - |
      chroot "$1" /usr/bin/env -i \
        HOME="/root" \
        PATH="/usr/sbin:/usr/bin:/sbin:/bin" \
        POLYPOD_USER="$IGconf_device_user1" \
        /bin/bash /opt/polypod/scripts/init.sh

    # 3) Install a systemd service to run your runtime startup script every boot
    - |
      install -m 0644 "${@SRCROOT}/polypod.service" "$1/etc/systemd/system/polypod.service"

    # 4) Enable services at build time
    - $BDEBSTRAP_HOOKS/enable-units "$1" polypod